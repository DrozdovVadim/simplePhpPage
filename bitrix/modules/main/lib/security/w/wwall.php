<? namespace Bitrix\Main\Security\W;$GLOBALS['____102531081']= array(base64_decode('dGltZQ=='),base64_decode('d'.'GltZQ=='),base64_decode('a'.'nNvb'.'l9kZ'.'WNvZGU='),base64_decode(''.'Y'.'XJyY'.'Xlf'.'b'.'WVyZ2'.'U'.'='),base64_decode('am9pbg=='),base64_decode('am9'.'pbg='.'='),base64_decode(''.'am'.'9'.'pbg'.'=='),base64_decode('YXJyYXlfcG9'.'w'),base64_decode(''.'YXJyYXl'.'fc2hp'.'Zn'.'Q='),base64_decode('YXJyYXlfc'.'2hpZnQ='),base64_decode('YX'.'JyYXlfc2hp'.'Zn'.'Q'.'='),base64_decode('YX'.'JyYXlfc2hpZnQ'.'='),base64_decode('Y'.'XJyYXlfb'.'W'.'VyZ2U'.'='),base64_decode('aXNf'.'YXJ'.'yYXk='),base64_decode(''.'Y'.'XJ'.'yYXlf'.'bW'.'VyZ'.'2'.'U='),base64_decode('aW5fY'.'XJyYXk='),base64_decode(''.'aW'.'5fYXJyYXk='),base64_decode('aW5f'.'YXJyYX'.'k'.'='),base64_decode('aW'.'5'.'f'.'YXJyY'.'Xk='),base64_decode(''.'aW5f'.'YXJyYXk='),base64_decode('dGltZQ'.'=='),base64_decode('dGltZQ=='),base64_decode('YXJ'.'yYXlf'.'bWFw'),base64_decode('Z2V0X2x'.'vYWRl'.'ZF'.'9l'.'eHRlbnN'.'pb25z'),base64_decode('anNvbl9lbm'.'NvZG'.'U='),base64_decode('anNvb'.'l9lbmN'.'vZGU'.'='),base64_decode('cGhwdmV'.'yc2lvb'.'g'.'=='),base64_decode(''.'a'.'nNvbl9lbmNvZG'.'U='),base64_decode('a'.'m9pbg'.'=='));if(!function_exists(__NAMESPACE__.'\\___1850474495')){function ___1850474495($_181408483){static $_460730589= false; if($_460730589 == false) $_460730589=array('V'.'1dBTE'.'xfTE9DS'.'w==','c2VjdXJp'.'d'.'Hk'.'=','RE'.'FUQQ==','eyI=','V'.'1'.'dBTExf'.'TE9DSw==',''.'c2VjdXJpdHk'.'=',''.'U0V'.'D'.'VVJ'.'J'.'VFlf'.'V1'.'dB'.'TExf'.'RVhD'.'R'.'VBUSU9O','R'.'k'.'FJTF9DSEVDS0l'.'ORw'.'='.'=','Q2F'.'uI'.'G5vdCBleG'.'VjdXRlIH'.'d3YW'.'xs'.'IH'.'J1bGVzO'.'iA'.'=',''.'IFR'.'yYWNlO'.'iA=','U'.'kVRVUV'.'T'.'VF9VUkk=','a2V'.'5cw'.'==','d'.'mFsdWV'.'z','U'.'0V'.'DVVJ'.'JVFlfV1dBTExfT'.'U9'.'ESUZZ','Lg==',''.'U0VD'.'V'.'VJJV'.'FlfV1dBTExfVU5TRVQ=','Lg'.'==',''.'U0VDV'.'V'.'J'.'J'.'VFlf'.'V1dBTExfRVhJVA==','Lg'.'==',''.'Z2xvYmFs','a2'.'V5'.'cw='.'=','dmFsdW'.'Vz',''.'Z2V0','Z2V0','c'.'G9zdA==','cG9'.'zdA==','Y29va2ll','Y2'.'9'.'v'.'a2l'.'l','cm'.'V'.'x'.'dWVzd'.'A==','cmVxdW'.'VzdA='.'=',''.'Z2xvYmFs','Z2xvYmFs','bWFp'.'bl9zZ'.'WM=',''.'V'.'1d'.'BTExfQUNUVU'.'F'.'MSVp'.'FX1JVTEVT','dg==','dmVyc2'.'l'.'v'.'bg==','aQ'.'==',''.'aXNJbnN0YWxsZWQ=','dg==','aW'.'5p','bW'.'9kdWx'.'lcw==','bGljZW5zZQ==',''.'cGhw','dg==','ZXh0','c'.'2VjdXJpdHk=','Z'.'G'.'I'.'=',''.'dHlwZQ==','ZGI'.'=','dmVyc2'.'lvbg='.'=','Z'.'GI=','dHlwZQ==',''.'Z'.'GI=','dH'.'lw'.'ZQ==',''.'dmVy'.'c'.'2lv'.'bg==','ZGI'.'=','d'.'mVyc2lvbg'.'==','ZW52aXJvbm1lbnQ=','dm'.'1'.'fdm'.'Vyc'.'2lvbg='.'=','dm0=','dg==','ZW5'.'2aXJvb'.'m1lb'.'nQ'.'=','dm1f'.'dmV'.'yc2lvbg==','c2'.'9ja2V'.'0'.'VGltZW9'.'1dA'.'==','c3'.'RyZWF'.'t'.'VGltZW91dA='.'=','KCc=','ZGF0'.'YQ==','JywgJw==','b'.'W9kdWxl','J'.'ywgJw='.'=','bW9k'.'d'.'W'.'x'.'lX3ZlcnNpb2'.'4=',''.'J'.'yk=','LC'.'A'.'=',''.'U0VDVVJ'.'JVFl'.'fV1dBTExfR'.'Vh'.'DRVBUSU9O','bWFpb'.'g==','RkFJ'.'TF'.'9SRUZSRVNISU5H','Q2'.'FuIG5'.'vd'.'CB'.'yZWZyZXNoIHd'.'3Y'.'WxsIHJ1b'.'G'.'VzOiA=','IFRyYW'.'NlO'.'iA=','Z'.'GF0Y'.'Q==','eyI=','LS'.'0tL'.'S1CRU'.'dJ'.'TiBQVUJ'.'MSUMgS0'.'VZLS'.'0t'.'LS0=','Ck1'.'JSUJJakFOQmdr'.'cWh'.'raUc5dzBC'.'QVFFRkF'.'BT0NBUT'.'hBTUlJQkNnS'.'0NBUUVBcThRRTB'.'Iam1ISlVTdFd'.'WNm4wem'.'E'.'KUlZvTHgwMkt6YmZyYlM'.'v'.'UD'.'ZzV2F'.'4VHp3O'.'FNl'.'R'.'1'.'R'.'0'.'YlRDT3'.'JwSGk1UUY2T1J5alov'.'WHh6L0'.'tM'.'VTFHYm9mOUNaMw'.'o0'.'e'.'jd'.'Ta3FVdDY2aW'.'JY'.'dk9G'.'Q'.'ng0ZncvQ'.'VBQUkdEcXRtMG'.'5'.'EM'.'2Zn'.'R'.'3N'.'1M1JlU'.'G'.'d3Mj'.'lpOCt2bTdtdEJL'.'SlVZb'.'DRyClZwYj'.'Zz'.'ZlpF'.'VDlLRW'.'I'.'2VDF'.'IRFl'.'tRXZjMW'.'h'.'x'.'L2lpdXl4THJaWmk1'.'UT'.'ZV'.'ZmY'.'0'.'V'.'UV2'.'VEk'.'rN'.'jhzc0Z'.'S'.'a1E'.'r'.'b3d'.'UUnkKZ'.'U9JTWJGaE0vV'.'VRt'.'Z'.'lZ'.'ZYl'.'RSRnkyb1'.'VROFdNemEybko1U2'.'Foemk'.'xVUtPMWpB'.'alhUUF'.'Jyem'.'M3Q'.'Wp'.'1NjM5ajFPM'.'Ap'.'wcHFmbTV4Z1dsR'.'kFKa0hRV'.'G'.'di'.'ZGQ1'.'QVdxRE'.'Z'.'Ra'.'3'.'Q5S'.'EtrWStUbmZCT'.'EdWT'.'XZW'.'eVB'.'3VE'.'hO'.'V'.'1FZQXc0eHBnL3dBClp3SU'.'RBUUFC'.'Ci0tLS0tRU5'.'EIFB'.'VQkxJ'.'QyBLRVkt'.'L'.'S0tLQ='.'=');return base64_decode($_460730589[$_181408483]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_322714801= true; public function handle(){ try{  $_87844019= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_87844019)){ return;}  $_919213838= Cache::createInstance(); $_1372335123= false; if($_919213838->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1633367809= $_919213838->getVars(); if($GLOBALS['____102531081'][0]()- $_1633367809> round(0+10+10)){  $_617004302= Application::getConnection(); $_1094492932= RuleRecordTable::getTableName(); $_617004302->truncateTable($_1094492932); RuleRecordTable::cleanCache(); $_919213838->clean(___1850474495(0), ___1850474495(1));}} elseif($_919213838->startDataCache()){  $_919213838->endDataCache($GLOBALS['____102531081'][1]()); $_1372335123= true;} foreach($_87844019 as $_107843441){ $_58609437= new PublicKeyCipher; $_671729957= $_58609437->decrypt($_107843441[___1850474495(2)], static::__791134617()); if(!str_starts_with($_671729957, ___1850474495(3))){ continue;} $_513444022= $GLOBALS['____102531081'][2]($_671729957, true); if(!empty($_513444022)){ $_1505349315= Rule::make($_513444022); $_1726996026= $this->handleRule($_1505349315); $this->applyHandlingResults($_1726996026);}}  if($_1372335123){ $_919213838->clean(___1850474495(4), ___1850474495(5));}} catch(\Throwable $_1254236457){ $this->logEvent( ___1850474495(6), ___1850474495(7), ___1850474495(8). $_1254236457->getMessage(). ___1850474495(9). $_1254236457->getTraceAsString());}}  public function handleRule(Rule $_1505349315): array{ $_1726996026=[]; if($_1505349315->matchPath($_SERVER[___1850474495(10)])){  $_1942310944= $this->getContextElements($_1505349315->getContext()); foreach($_1942310944 as $_640434321 => &$_130084043){ $_1726996026= $GLOBALS['____102531081'][3]($_1726996026, $this->recursiveContextKeyHandle($_640434321, $_130084043,[], $_1505349315));}} return $_1726996026;}  public function applyHandlingResults(array $_1726996026){ $_1942310944= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1726996026 as $_1137272350){ $_130084043=& $_1942310944[$_1137272350->getContextName()]; $_1886679905= $_1137272350->getRuleResult(); $_1505349315= $_1137272350->getRule(); if($_1886679905 instanceof ModifyResult){ if($_1505349315->getProcess() === ___1850474495(11)){  static::rewriteContextKey( $_1137272350->getContextName(), $_130084043, $_1137272350->getContextKey(), $_1886679905->getCleanValue());} elseif($_1505349315->getProcess() === ___1850474495(12)){ static::rewriteContextValue( $_1137272350->getContextName(), $_130084043, $_1137272350->getContextKey(), $_1886679905->getCleanValue());} $this->logEvent( ___1850474495(13), $_1137272350->getContextName(), $GLOBALS['____102531081'][4](___1850474495(14), $_1137272350->getContextKey()));} elseif($_1886679905 instanceof CheckResult &&!$_1886679905->isSuccess()){ if($_1886679905->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1137272350->getContextName(), $_130084043, $_1137272350->getContextKey(),); $this->logEvent( ___1850474495(15), $_1137272350->getContextName(), $GLOBALS['____102531081'][5](___1850474495(16), $_1137272350->getContextKey()));} elseif($_1886679905->getAction() === RuleAction::EXIT){ $this->logEvent( ___1850474495(17), $_1137272350->getContextName(), $GLOBALS['____102531081'][6](___1850474495(18), $_1137272350->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_322714801= false;} protected function rewriteContextKey($_640434321, &$_130084043, $_1999150119, $_662351094){ $_1289382747= $_1999150119;  $GLOBALS['____102531081'][7]($_1289382747); $_1289382747[]= $_662351094; if($_640434321 === ___1850474495(19)){ $_155989255= $GLOBALS['____102531081'][8]($_1999150119); $GLOBALS['____102531081'][9]($_1289382747); if(empty($_1999150119)){ $GLOBALS[$_662351094]= $GLOBALS[$_155989255]; unset($GLOBALS[$_155989255]);} else{ $_130084043=& $GLOBALS[$_155989255]; $_1811680169= ArrayHelper::getByNestedKey($_130084043, $_1999150119);  ArrayHelper::setByNestedKey($_130084043, $_1289382747, $_1811680169);  ArrayHelper::unsetByNestedKey($_130084043, $_1999150119);}} else{ $_1811680169= ArrayHelper::getByNestedKey($_130084043, $_1999150119);  ArrayHelper::setByNestedKey($_130084043, $_1289382747, $_1811680169);  ArrayHelper::unsetByNestedKey($_130084043, $_1999150119);}} protected function rewriteContextValue($_640434321, &$_130084043, $_948257113, $_1811680169){ if($_640434321 === 'global'){ $_155989255= $GLOBALS['____102531081'][10]($_948257113); if(empty($_948257113)){ $GLOBALS[$_155989255]= $_1811680169;} else{ $_130084043=& $GLOBALS[$_155989255]; ArrayHelper::setByNestedKey($_130084043, $_948257113, $_1811680169);}} else{  ArrayHelper::setByNestedKey($_130084043, $_948257113, $_1811680169);}} protected function unsetContextValue($_640434321, &$_130084043, $_948257113){ if($_640434321 === 'global'){ $_155989255= $GLOBALS['____102531081'][11]($_948257113); if(empty($_948257113)){ unset($GLOBALS[$_155989255]);} else{ $_130084043=& $GLOBALS[$_155989255]; ArrayHelper::unsetByNestedKey($_130084043, $_948257113);}} else{ ArrayHelper::unsetByNestedKey($_130084043, $_948257113);}}  protected function recursiveContextKeyHandle(string $_640434321, array &$_130084043, array $_838262385, Rule $_1505349315): array{  $_1726996026=[]; foreach($_130084043 as $_821151330 => $_1811680169){ $_948257113= $GLOBALS['____102531081'][12]($_838262385,[$_821151330]); if($_1505349315->matchKey($_948257113)){  if($_1505349315->getProcess() === ___1850474495(20)){ $_1886679905= $_1505349315->evaluate($_821151330);} elseif($_1505349315->getProcess() === ___1850474495(21)){ $_1886679905= $_1505349315->evaluateValue($_1811680169);}  if(!empty($_1886679905) && $_1886679905 instanceof RuleResult){ $_1726996026[]= new HandlingResult($_640434321, $_948257113, $_1886679905, $_1505349315);}}  if($GLOBALS['____102531081'][13]($_1811680169)){ $_1726996026= $GLOBALS['____102531081'][14]($_1726996026, $this->recursiveContextKeyHandle( $_640434321, $_130084043[$_821151330], $_948257113, $_1505349315));}} return $_1726996026;} protected function getContextElements(array $_1854509887){ $_683562671=[]; if($GLOBALS['____102531081'][15](___1850474495(22), $_1854509887, true)){ $_683562671[___1850474495(23)]= &$_GET;} if($GLOBALS['____102531081'][16](___1850474495(24), $_1854509887, true)){ $_683562671[___1850474495(25)]= &$_POST;} if($GLOBALS['____102531081'][17](___1850474495(26), $_1854509887, true)){ $_683562671[___1850474495(27)]= &$_COOKIE;} if($GLOBALS['____102531081'][18](___1850474495(28), $_1854509887, true)){ $_683562671[___1850474495(29)]= &$_REQUEST;} if($GLOBALS['____102531081'][19](___1850474495(30), $_1854509887, true)){ $_683562671[___1850474495(31)]= $GLOBALS;} return $_683562671;} public static function refreshRules(){ try{ $_1528749415= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____102531081'][20]()- $_1528749415)< static::CACHE_RULES_TTL){ return;} Option::set(___1850474495(32), ___1850474495(33), $GLOBALS['____102531081'][21]()); $_1598426163= null;  $_97339885= $GLOBALS['____102531081'][22](function($_1714509554){ return[___1850474495(34) => $_1714509554[___1850474495(35)], ___1850474495(36) => (int) $_1714509554[___1850474495(37)]];}, ModuleManager::getModulesFromDisk());  $_1233309319=[]; foreach($GLOBALS['____102531081'][23]() as $_480105558){ $_613248091= new ReflectionExtension($_480105558); $_1233309319[$_480105558]=[ ___1850474495(38) => $_613248091->getVersion(), ___1850474495(39) => $_613248091->getINIEntries()];} $_672582025=[ ___1850474495(40) => $GLOBALS['____102531081'][24]($_97339885), ___1850474495(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1850474495(42) => $GLOBALS['____102531081'][25]([ ___1850474495(43) => $GLOBALS['____102531081'][26](), ___1850474495(44) => $_1233309319])]; if(Loader::includeModule(___1850474495(45))){ $_196197055= CSecuritySystemInformation::getSystemInformation(); if(isset($_196197055[___1850474495(46)][___1850474495(47)]) && isset($_196197055[___1850474495(48)][___1850474495(49)])){ $_672582025[___1850474495(50)]=[ ___1850474495(51) => $_196197055[___1850474495(52)][___1850474495(53)], ___1850474495(54) => $_196197055[___1850474495(55)][___1850474495(56)]];} if(isset($_196197055[___1850474495(57)][___1850474495(58)])){ $_672582025[___1850474495(59)]=[___1850474495(60) => $_196197055[___1850474495(61)][___1850474495(62)]];}}  $_1220557318= new HttpClient([ ___1850474495(63) => round(0+1.6666666666667+1.6666666666667+1.6666666666667), ___1850474495(64) => round(0+1.6666666666667+1.6666666666667+1.6666666666667)]); $_2037004767=(new UrlProvider())->getTechDomain(); $_1973567761="https://wwall.{$_2037004767}/rules.php"; $_165329372= $_1220557318->post($_1973567761, $_672582025); if($_1220557318->getStatus() == round(0+66.666666666667+66.666666666667+66.666666666667) &&!empty($_165329372)){ $_1598426163= Json::decode($_165329372);}  if($_1598426163 !== null){ $_617004302= Application::getConnection(); $_1094492932= RuleRecordTable::getTableName(); if(!empty($_1598426163)){ foreach($_1598426163 as $_675291362){ if(!static::checkRuleSign($_675291362)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____102531081'][27]($_675291362));}}}  $_617004302->truncateTable($_1094492932);  if(!empty($_1598426163)){ $_1950570422=[]; foreach($_1598426163 as $_675291362){ $_1950570422[]= ___1850474495(65). $_617004302->getSqlHelper()->forSql($_675291362[___1850474495(66)]). ___1850474495(67). $_617004302->getSqlHelper()->forSql($_675291362[___1850474495(68)]). ___1850474495(69). $_617004302->getSqlHelper()->forSql($_675291362[___1850474495(70)]). ___1850474495(71);} $_1734204325= $GLOBALS['____102531081'][28](___1850474495(72), $_1950570422);  $_617004302->query("INSERT INTO {$_1094492932} (DATA, MODULE, MODULE_VERSION) VALUES {$_1734204325}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1254236457){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1850474495(73), ___1850474495(74), ___1850474495(75), ___1850474495(76). $_1254236457->getMessage(). ___1850474495(77). $_1254236457->getTraceAsString());}} protected static function checkRuleSign($_1505349315){ $_58609437= new PublicKeyCipher; $_513444022= $_58609437->decrypt($_1505349315[___1850474495(78)], static::__791134617()); return str_starts_with($_513444022, ___1850474495(79));} private static function __791134617(){ $_2020734802= ''; $_2020734802 .= ___1850474495(80); $_2020734802 .= ___1850474495(81); return $_2020734802;} protected function logEvent($_1514412725, $_36694214, $_606630705){ if($this->_322714801){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1514412725, 'main', $_36694214, $_606630705);}}}?>